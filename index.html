<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Photobooth</title>
<style>
  body, html { margin:0; padding:0; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; background:#111; color:#fff; }
  video, canvas, img { max-width:100%; border-radius:10px; margin:10px 0; }
  button { margin:5px; padding:10px 20px; font-size:16px; border:none; border-radius:5px; cursor:pointer; }
  #controls { display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:10px; }
  input[type=file] { display:none; }
  #qrCanvas { margin:10px 0; }
  #timer { margin:5px; color:#ff6666; }
</style>
</head>
<body>

<h2>Photobooth</h2>

<!-- Controls -->
<div id="controls">
  <button id="takePhotoBtn">Take Photo</button>
  <button id="insertBtn">Upload/Insert Image</button>
  <input type="file" id="uploadImage" accept="image/*"/>
</div>

<!-- Preview -->
<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>
<img id="preview" alt="Preview" />
<canvas id="qrCanvas"></canvas>
<div id="timer"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
// --- Elements ---
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const preview = document.getElementById('preview');
const qrCanvas = document.getElementById('qrCanvas');
const uploadImage = document.getElementById('uploadImage');
const timerDisplay = document.getElementById('timer');

// --- Camera access ---
navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{ video.srcObject=stream; });

// --- Take photo ---
document.getElementById('takePhotoBtn').onclick = async ()=>{
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0);
  preview.src = canvas.toDataURL('image/png');
  await uploadAndGenerateQR();
};

// --- Upload/Insert image ---
document.getElementById('insertBtn').onclick = ()=>{
  uploadImage.click();
};

uploadImage.onchange = async ()=>{
  const file = uploadImage.files[0];
  if(!file) return;
  const img = new Image();
  img.onload = async ()=>{
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img,0,0);
    preview.src = canvas.toDataURL('image/png');
    await uploadAndGenerateQR();
  };
  img.src = URL.createObjectURL(file);
};

// --- Upload to Cloudinary & generate QR ---
async function uploadAndGenerateQR(){
  const blob = await new Promise(resolve=>canvas.toBlob(resolve,'image/png'));
  try {
    const formData = new FormData();
    formData.append('file', blob);
    formData.append('upload_preset', 'unsigned_photobooth'); // your unsigned preset

    const res = await fetch('https://api.cloudinary.com/v1_1/djgaxcy0r/image/upload',{
      method:'POST',
      body: formData
    });
    const data = await res.json();
    console.log('Uploaded:', data);

    const url = `https://yourdomain.com/?photo_id=${data.public_id}`; // replace with your domain
    QRCode.toCanvas(qrCanvas, url, { width: 200 });

    // Start limited-time access timer (1 hour = 3600s)
    startTimer(3600);
  } catch(e){ console.error(e); }
}

// --- Timer for limited-time access ---
let timerInterval;
function startTimer(seconds){
  clearInterval(timerInterval);
  let remaining = seconds;
  timerInterval = setInterval(()=>{
    const hrs = Math.floor(remaining/3600);
    const mins = Math.floor((remaining%3600)/60);
    const secs = remaining%60;
    timerDisplay.textContent = `QR expires in: ${hrs}h ${mins}m ${secs}s`;
    remaining--;
    if(remaining<0){
      clearInterval(timerInterval);
      timerDisplay.textContent = 'QR expired';
      qrCanvas.style.display='none';
      preview.style.opacity='0.5';
    }
  },1000);
}
</script>
</body>
</html>async function uploadAndGenerateQR(){
  const blob = await new Promise(resolve=>canvas.toBlob(resolve,'image/png'));
  try {
    // Get signature from backend
    const sigRes = await fetch('http://localhost:3000/get-signature'); // replace with your backend
    const { signature, timestamp } = await sigRes.json();

    const formData = new FormData();
    formData.append('file', blob);
    formData.append('upload_preset', 'signed_photobooth');
    formData.append('timestamp', timestamp);
    formData.append('signature', signature);

    const res = await fetch('https://api.cloudinary.com/v1_1/djgaxcy0r/image/upload',{method:'POST',body:formData});
    const data = await res.json();

    console.log('Uploaded:', data);

    // QR pointing to website with photo_id
    // For local testing, replace window.location.origin with local IP if scanning another device
    const url = `${window.location.origin}/?photo_id=${data.public_id}`;
    QRCode.toCanvas(qrCanvas, url, { width:200 }, function(error){
      if(error) console.error(error);
      else console.log('QR generated!');
    });

  } catch(e){ console.error(e); }
}

// -------- Scanner Mode --------
const scannedImg = document.getElementById('scannedImg');
const scannerUpload = document.getElementById('scannerUpload');
const scannerCanvas = document.getElementById('scannerCanvas');
const downloadBtn = document.getElementById('downloadBtn');

const html5QrCode = new Html5Qrcode("scannerVideo");
html5QrCode.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  async (decodedText)=>{
    html5QrCode.stop();
    try{
      const res = await fetch(`http://localhost:3000/get-signed-url?public_id=${decodedText}`);
      const { url } = await res.json();
      scannedImg.src = url;
    } catch(e){ console.error(e); }
  }
);

// Insert/upload image in scanner mode
document.getElementById('scannerInsertBtn').onclick = ()=>{
  const file = scannerUpload.files[0];
  if(!file) return alert('Select an image first');
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Photobooth</title>
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; }
  video, img, canvas { max-width: 90%; margin: 10px 0; border-radius: 10px; }
  button { padding: 10px 20px; margin: 5px; font-size: 16px; border-radius: 8px; cursor: pointer; }
  #qrCanvas { margin-top: 20px; }
</style>
</head>
<body>

<h2>Photobooth</h2>

<video id="camera" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>
<img id="preview" alt="Preview">

<div>
  <button id="takePhotoBtn">Take Photo</button>
  <button id="insertBtn">Upload Image</button>
  <input type="file" id="uploadImage" style="display:none" accept="image/*">
</div>

<canvas id="qrCanvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const uploadImage = document.getElementById('uploadImage');
const insertBtn = document.getElementById('insertBtn');
const camera = document.getElementById('camera');
const takePhotoBtn = document.getElementById('takePhotoBtn');
const canvas = document.getElementById('canvas');
const preview = document.getElementById('preview');
const qrCanvas = document.getElementById('qrCanvas');

// Start camera
navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
  .then(stream => { camera.srcObject = stream; })
  .catch(err => { alert('Camera not available'); console.error(err); });

// Upload button
insertBtn.onclick = () => uploadImage.click();

// Handle uploaded file
uploadImage.addEventListener('change', async () => {
  const file = uploadImage.files[0];
  if (!file) return;
  const img = new Image();
  img.onload = async () => {
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    preview.src = canvas.toDataURL('image/png');
    await uploadAndGenerateQR();
  };
  img.src = URL.createObjectURL(file);
});

// Take photo from camera
takePhotoBtn.onclick = async () => {
  canvas.width = camera.videoWidth;
  canvas.height = camera.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(camera, 0, 0);
  preview.src = canvas.toDataURL('image/png');
  await uploadAndGenerateQR();
};

// Upload to Cloudinary and generate QR
async function uploadAndGenerateQR() {
  const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
  const formData = new FormData();
  formData.append('file', blob);
  formData.append('upload_preset', 'unsigned_photobooth');

  try {
    const res = await fetch('https://api.cloudinary.com/v1_1/djgaxcy0r/image/upload', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    console.log('Uploaded:', data);

    // QR code pointing to website with photo ID
    const url = `${window.location.origin}/?photo_id=${data.public_id}`;
    QRCode.toCanvas(qrCanvas, url, { width: 200 }, err => {
      if (err) console.error(err);
    });
  } catch (err) {
    console.error('Upload failed', err);
  }
}
</script>
</body>
</html>
